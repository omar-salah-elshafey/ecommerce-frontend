<div class="blog-details">
  <button mat-raised-button routerLink="/content" class="back-button">
    <mat-icon>arrow_back</mat-icon>
    العودة إلى المحتوى
  </button>

  <ng-container *ngIf="blog as blog; else loading">
    <ng-container *ngIf="!isEditing">
      <mat-card>
        <mat-card-header>
          <div
            class="admin-actions"
            *ngIf="
              (authService.isAdmin$ | async) ||
              (authService.isSuperAdmin$ | async)
            "
          >
            <button mat-icon-button [matMenuTriggerFor]="adminMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #adminMenu="matMenu">
              <button mat-menu-item (click)="startEditing()">
                <mat-icon>edit</mat-icon>
                <span>تعديل</span>
              </button>
              <button mat-menu-item (click)="deleteBlog()">
                <mat-icon>delete</mat-icon>
                <span>حذف</span>
              </button>
            </mat-menu>
          </div>
          <mat-card-title>{{ blog.title }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="content" [innerHTML]="blog.content"></div>
          <div class="meta-info">
            <span class="date">{{
              blog.publishDate | date : "dd/MM/yyyy"
            }}</span>
          </div>
          <!-- Media Container -->
          <div class="media" *ngIf="blog.imageUrl || blog.videoUrl">
            <img
              *ngIf="blog.imageUrl"
              [src]="blog.imageUrl"
              [alt]="blog.title"
              class="blog-image"
            />

            <div *ngIf="blog.videoUrl" class="video-container">
              <iframe
                [src]="getEmbedVideoUrl(blog.videoUrl) | safeUrl"
                [title]="blog.title"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>
    <ng-container
      *ngIf="
        isEditing &&
        ((authService.isAdmin$ | async) || (authService.isSuperAdmin$ | async))
      "
    >
      <div class="edit-post-form">
        <form [formGroup]="editForm">
          <mat-form-field appearance="outline">
            <mat-label> العنوان </mat-label>
            <input
              matInput
              id="title"
              formControlName="title"
              placeholder="العنوان"
            />
            <mat-error *ngIf="editForm.get('title')?.hasError('required')">
              هذا الحقل مطلوب.
            </mat-error>
            <mat-error *ngIf="editForm.get('title')?.hasError('minlength')">
              يجب أن يكون العنوان على الأقل 1 حرف.
            </mat-error>
            <mat-error *ngIf="editForm.get('title')?.hasError('maxlength')">
              لا يمكن أن يتجاوز العنوان 200 حرف.
            </mat-error>
            <mat-error *ngIf="editForm.get('title')?.hasError('pattern')">
              لا يمكن أن يكون العنوان فارغًا أو يحتوي على مسافات فقط.
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label> المحتوى </mat-label>
            <textarea
              id="content"
              matInput
              rows="5"
              formControlName="content"
              placeholder="المحتوى"
            ></textarea>
            <mat-error *ngIf="editForm.get('content')?.hasError('required')">
              هذا الحقل مطلوب.
            </mat-error>
            <mat-error *ngIf="editForm.get('content')?.hasError('minlength')">
              يجب أن يكون العنوان على الأقل 1 حرف.
            </mat-error>
            <mat-error *ngIf="editForm.get('content')?.hasError('maxlength')">
              لا يمكن أن يتجاوز العنوان 200 حرف.
            </mat-error>
            <mat-error *ngIf="editForm.get('content')?.hasError('pattern')">
              لا يمكن أن يكون العنوان فارغًا أو يحتوي على مسافات فقط.
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label> فيديو يوتيوب </mat-label>
            <input
              matInput
              id="videoUrl"
              formControlName="videoUrl"
              placeholder="فيديو يوتيوب"
            />
          </mat-form-field>

          <div class="upload-container">
            <!-- <label
              *ngIf="!imageFile && !imagePreviewUrl"
              class="upload-btn"
              [class.disabled]="updating"
            >
              <mat-icon>image</mat-icon>
              <input
                #imageInput
                type="file"
                (change)="onFileSelected($event, 'image')"
                accept="image/*"
                [disabled]="updating"
              />
            </label> -->

            <label
              *ngIf="!imageChangedEvent && !imageFile && !imagePreviewUrl"
              class="upload-btn"
              [class.disabled]="updating"
            >
              <mat-icon>image</mat-icon>
              <input
                #imageInput
                type="file"
                (change)="onFileSelected($event, 'image')"
                accept="image/*"
                [disabled]="updating"
              />
            </label>

            <!-- Cropping tool appears only when an image is selected -->
            <div *ngIf="imageChangedEvent" class="cropper-container">
              <image-cropper
                [imageChangedEvent]="imageChangedEvent"
                [maintainAspectRatio]="true"
                [aspectRatio]="1 / 1"
                (imageCropped)="imageCropped($event)"
                format="jpeg"
                output="base64"
              ></image-cropper>

              <!-- Action buttons -->
              <div class="cropper-actions">
                <button
                  mat-button
                  color="primary"
                  (click)="uploadCroppedImage()"
                  [disabled]="!croppedImage || updating"
                >
                  حفظ
                </button>
                <button
                  mat-button
                  color="warn"
                  (click)="cancelCropping()"
                  [disabled]="updating"
                >
                  إلغاء
                </button>
              </div>
            </div>

            <!-- <label
              *ngIf="!videoFile && !videoPreviewUrl"
              class="upload-btn"
              [class.disabled]="updating"
            >
              <mat-icon>videocam</mat-icon>
              <input
                #videoInput
                type="file"
                (change)="onFileSelected($event, 'video')"
                accept="video/*"
                [disabled]="updating"
              />
            </label> -->
          </div>

          <div class="selected-files">
            <!-- <div *ngIf="imageFile || imagePreviewUrl" class="file-preview">
              <div class="preview-container">
                <img
                  [src]="imagePreviewUrl"
                  [alt]="imageFile?.name || blog.title"
                  class="preview-image"
                />
              </div>
              <button
                type="button"
                class="remove-file"
                (click)="removeFile('image')"
                [disabled]="updating"
                [class.disabled]="updating"
              >
                ×
              </button>
            </div> -->

            <div class="selected-files">
              <div
                *ngIf="imageFile || croppedImage || imagePreviewUrl"
                class="file-preview"
              >
                <div class="preview-container">
                  <img
                    [src]="croppedImage || imagePreviewUrl"
                    alt="Cropped or new image"
                    class="preview-image"
                  />
                </div>
                <button
                  type="button"
                  class="remove-file"
                  (click)="removeFile('image')"
                  [disabled]="updating"
                  [class.disabled]="updating"
                >
                  &times;
                </button>
              </div>

              <!-- <div
                *ngIf="!imageFile && !croppedImage && blog.imageUrl"
                class="file-preview"
              >
                <div class="preview-container">
                  <img
                    [src]="blog.imageUrl"
                    alt="Current image from server"
                    class="preview-image"
                  />
                </div>
                <button
                  type="button"
                  class="remove-file"
                  (click)="removeFile('image')"
                  [disabled]="updating"
                  [class.disabled]="updating"
                >
                  ×
                </button>
              </div> -->
            </div>

            <!-- <div *ngIf="videoFile || videoPreviewUrl" class="file-preview">
              <div class="preview-container">
                <video
                  *ngIf="!videoFile && videoPreviewUrl"
                  [src]="videoPreviewUrl"
                  class="preview-image"
                  muted
                  preload="metadata"
                  disablePictureInPicture
                  controlsList="nodownload nofullscreen noremoteplayback"
                ></video>
                <img
                  *ngIf="videoFile && videoPreviewUrl"
                  [src]="videoPreviewUrl"
                  [alt]="videoFile.name || 'Video Preview'"
                  class="preview-image"
                />
              </div>
              <button
                type="button"
                class="remove-file"
                (click)="removeFile('video')"
                [disabled]="updating"
                [class.disabled]="updating"
              >
                ×
              </button>
            </div> -->
          </div>

          <div class="form-actions">
            <button
              class="btn"
              type="submit"
              [disabled]="editForm.invalid || updating"
              (click)="onUpdatePost()"
            >
              {{ updating ? "جاري الحفظ..." : "حفظ التغييرات" }}
            </button>
            <button
              class="btn cancel-btn"
              type="button"
              (click)="cancelEditing()"
              [disabled]="updating"
            >
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </ng-container>
  </ng-container>

  <ng-template #loading>
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  </ng-template>
</div>
